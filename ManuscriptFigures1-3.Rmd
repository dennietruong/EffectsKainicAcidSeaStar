---
title: "ManuscriptFigures"
author: "DennieT"
date: "2024-08-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(readr)
library(tidyr)
library(ggplot2)
library("tidyverse")
library(ggplot2)
library(plyr)
library('pracma')

```



Set working directory
```{r}
here::i_am("ManuscriptFigures.Rmd")
```

## Figure 1
Import Data & Clean up
```{r}
Pisaster <- read.csv("ELISAPisastersData.csv", header=TRUE) #header TRUE mean first line of csv has heading
#Add a column to id species: Pisaster ochraceus
Pisaster$Species <- "P. ochraceus"
Pisaster_long1 <- gather(Pisaster, Tissue, DA, PC:D, factor_key=TRUE) #convert data from long to wide




Asterias <- read.csv("ELISAAsteriasData.csv", header=TRUE) 
#Add a column to id species: Asterias forbesi
Asterias$Species <- "Asterias spp."




#Combine both sea star species data
SeaStars <- full_join(x = Pisaster_long1, y = Asterias)

#Data cleaning
SeaStars <- SeaStars[, c("Species", "BodyMass_g", "Tissue", "DA")]
SeaStars <- na.omit(SeaStars)
#Indexing
SeaStars <- SeaStars[SeaStars$Tissue == "PC", ]
```



Clean Up Continue: Remove rows with NAs in Long Format
```{r}
Pisaster_long2 <- Pisaster_long1
Pisaster_long2 <- Pisaster_long2[!is.na(Pisaster_long2$DA), ] # remove NAs based on the DA column



Pisaster2 <- na.omit(Pisaster) #Omit all rows with NAs, effectively removing everything but stars with all 4 tissues analyzed
Pisaster_long3<- gather(Pisaster2, Tissue, DA, PC:D, factor_key=TRUE) #Only all the stars that had all 4 tissues analyzed
 
```







Figure 1A: Boxplot
```{r}
#For significant bar 
Figure1A <- ggplot(data = Pisaster_long3, mapping = aes(x=Tissue,y=DA))+
  geom_boxplot(aes(fill = Tissue), 
               lwd = 0.3, fatten = 0.3, 
               color = "Black", 
               outlier.shape = 16, 
               outlier.size = 0.7, 
               notch = FALSE)+
  #geom_jitter(position = position_jitter(width = .02, height=-0.7), 
              #color = "Azure4", 
              #size = 3)+
  xlab(expression(paste(italic("Pisaster ochraceus"), " Tissue")))+
  ylab(expression(paste("Domoic Acid (ng g"^-1, " tissue)"))) +
  #ylab(expression(paste("Domoic Acid (", over("ng DA","g tissue")," )"))) +
  scale_x_discrete(limits = c('PC','PS','TF','D'),
                   labels = c('Pyloric caeca','Stomach','Tube feet','Dermis'))+
  scale_fill_manual(values=c("#F8766D","#7CAE00", "#00BFC4","#C77CFF"))+
  stat_summary(fun.y=mean, geom="point", shape=5, size=1)+
  theme_bw() +
  theme(panel.border = element_rect(fill = NA)) + #for border around plot
  theme(
        axis.text = element_text(size = 8), 
        axis.title = element_text(size = 8),
        axis.title.x = element_text(size = 9), # Set the x-axis label size
        axis.title.y = element_text(size = 9), # Set the y-axis label size
        legend.position = 'none' #Remove legend
        ) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + #Remove gridlines
  coord_cartesian(xlim = c(0.4, 4.6),
                  ylim = c(0, 1200),
                  expand = FALSE) +  # Set the y-axis limits
  #Create the significance letter 
  annotate("text", x = 1, y = 1140, label = "a", size = 3) +
  annotate("text", x = 3, y = 440, label = "b", size = 3) +
  geom_segment(aes(x = 0.65, y = 1100, xend = 1.35, yend = 1100), color = "black") + # Adding limited horizontal line
  geom_segment(aes(x = 1.65, y = 400, xend = 4.35, yend = 400), color = "black")  # Adding limited horizontal line
  


#png(filename = 'Figure1A.png', height = 1500, width = 2600, res = 400)

Figure1A #plot the plot


#dev.off() # turns off graphics device and exports the plot

```





Figure 1B: ELISA Tests Analysis for Asteria forbesi
```{r}
Figure1B <- ggplot(data = Asterias, mapping = aes(x=Tissue,y=DA))+
  geom_boxplot(aes(fill = Tissue), lwd = 0.3, fatten = 0.3, color = "Black", outlier.shape = 16, outlier.size = 0.7, notch = FALSE)+
  #geom_jitter(position = position_jitter(width = .02, height=-0.7), color = "Azure4", size = 3)+
  xlab(expression(paste(italic("Asterias"), " spp. Tissue")))+
  ylab(expression(paste("Domoic Acid (ng g"^-1, " tissue)"))) +
  scale_x_discrete(limits = c('PC','PS','TF','D'),
                   labels = c('Pyloric caeca','Stomach','Tube feet','Dermis'))+
  scale_fill_manual(values=c("#C77CFF", "#F8766D","#7CAE00", "#00BFC4"))+
  stat_summary(fun.y=mean, geom="point", shape=23, size=2)+
  theme_bw() +
  theme(panel.border = element_rect(fill = NA)) +
  theme(axis.text = element_text(size = 8), 
        axis.title = element_text(size = 8),
        axis.title.x = element_text(size = 9),  # Set the x-axis label size
        axis.title.y = element_text(size = 9)) + # Set the y-axis label size
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + #Remove gridlines
  theme(legend.position = 'none') 
  # + coord_cartesian(xlim = c(0.4, 4.6),
                 # ylim = c(0, 1200),
                  #expand = FALSE)   # Set the y-axis limits
  


#png(filename = 'Figure1B.png', height = 70, width = 100, units = "mm", res = 400) #defines png, res is in dpi, h & w in pixels
Figure1B #plot the plot

#pdf('Figure1B.pdf', height = 70/25.4, width = 100/25.4)  # Convert mm to inches
Figure1B #plot the plot

#dev.off() # turns off graphics device and exports the plot
```








Combine Figure 1A and 1B
```{r}
library(patchwork)
library(cowplot)

# Combine plots into a stacked layout
stacked_plots <- plot_grid(Figure1A, Figure1B, labels = "AUTO", label_size = 11, align = "v", hjust= -0.3, vjust = 2, scale = 0.94)

#Paper
png(filename = 'Figure1.png', height = 100, width = 169, units = "mm", res = 400)
stacked_plots #plot the plot

pdf('Figure1.pdf', height = 100/25.4, width = 169/25.4)  # Convert mm to inches
stacked_plots #plot the plot


dev.off() # turns off graphics device and exports the plot
```










Figure 2
```{r}
#Filter out just Pisaster pyloric caeca (PC) data ONLY
PisasterPC <- SeaStars[SeaStars$Species == "P. ochraceus", ]


#Create dataframe for prediction
df_pred = data.frame(BodyMass_g = seq(min(PisasterPC$BodyMass_g), max(PisasterPC$BodyMass_g), 0.2))

# Linear-log regression
mod_linlog_lm = lm(DA ~ log(BodyMass_g), data = PisasterPC)
summary(mod_linlog_lm)


# Prediction and standard error
df_pred$linlog_fit = predict(mod_linlog_lm, newdata = df_pred, se.fit = F)
df_pred$linlog_SE = predict(mod_linlog_lm, newdata = df_pred, se.fit = T)$se.fit


#Linear-Log model includes only P. ochraceus data
#Figure plots both Asterias & Pisaster data points


#Make sure that the factor levels of Species in your SeaStars data frame are in the same order as the color assignment in scale_color_manual()
SeaStars$Species <- factor(SeaStars$Species, 
                           levels = c("P. ochraceus", "Asterias spp."))




# Create the plot
Figure2 <- ggplot() + 
  # Add in data points for both sea star species
  geom_point(aes(x = BodyMass_g, y = DA, color = Species), 
             data = SeaStars, size = 1) +  
  
  # Add confidence interval ribbon from df_pred
  geom_ribbon(aes(x = BodyMass_g, 
                  ymin = linlog_fit - linlog_SE * 1.96, 
                  ymax = linlog_fit + linlog_SE * 1.96),
              alpha = 0.1, 
              data = df_pred) +
  
  # Add fitted line from df_pred
  geom_line(aes(x = BodyMass_g, y = linlog_fit), 
            data = df_pred) + 
  
  # Graph accesories
  ylab(expression(paste("Domoic Acid (ng g"^-1, " pyloric caeca tissue)"))) +
  xlab("Body Mass (g)") + 
  theme_bw() + 
  theme(panel.border = element_rect(fill = NA)) +
  theme(axis.text = element_text(size = 8), 
        axis.title = element_text(size = 8),
        axis.title.x = element_text(size = 9),  
        axis.title.y = element_text(size = 9),
        legend.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.key.size = unit(0.5, 'mm')) +   
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + # Remove gridlines
  theme(legend.position = c(0.82,0.83)) + # Position the legend box
  coord_cartesian(xlim = c(-0.2, 260),
                  ylim = c(0, 1100),
                  expand = FALSE) +  
  #scale_color_manual(values = c("P. ochraceus" = "purple", "Asterias spp." = "red")) 
  scale_color_manual(
  values = c("P. ochraceus" = "purple", "Asterias spp." = "red"),
  labels = c(
    expression(italic("P. ochraceus")),
    expression(italic("Asterias")~"spp.")
  )
)
  
 
Figure2



png(filename = 'Figure2.png', height = 70, width = 100, units = "mm", res = 400) #defines png, res is in dpi, h & w in pixels
Figure2 #plot the plot

pdf('Figure2.pdf', height = 70/25.4, width = 100/25.4)  # Convert mm to inches
Figure2 #plot the plot

dev.off() # turns off graphics device and exports the plot
```








##Figure 3
Import Data
```{r}
DATABaseline <- read.csv("Experiment_BaselineData.csv", header=TRUE) #header TRUE mean first line of csv has heading

#Convert righting time from sec to min (baseline data)
DATABaseline$RightingTime = DATABaseline$RightingTime/60 




# Load the data
DATAResponse <- read.csv("Experiment_RightingArmCircumData.csv", header = TRUE)

# Convert 'Date' column to proper Date format
DATAResponse$Date2 <- as.Date(DATAResponse$Date, format = "%m/%d/%Y")

# Filter rows by specific date using a proper Date object
DATAResponse <- DATAResponse %>% 
  filter(Date2 == as.Date("2023-04-06"))

#Convert righting time from sec to min (Response data)
DATAResponse$RightingTime = DATAResponse$RightingTime/60 
```



All treatments: Arm circumference v Mass (Basline)
```{r}

ArmBefore = ggplot(DATABaseline, aes(x=BodyMass_g, y=ArmCircumference,color = factor(Treatment)))+ 
  ylab("Arm Circumference (cm)") + 
  xlab("Body Mass (g)") + 
  ggtitle("Pre-experiment baseline")+
  geom_point(size=1) +  # Increase the size of the points 
  labs(color ="Treatment", labels = c("KA, 30 ppb",
                                      "KA, 3 ppb",
                                      "PBS")) +
  scale_color_manual(values=c("firebrick",
                              "darkorange",
                              "deepskyblue")) +
  geom_smooth(method="lm", se=FALSE, size = 0.5) +  # Add predictor lines using linear regression
  theme_bw() +
  theme(panel.border = element_rect(fill = NA)) +
  theme(axis.text = element_text(size = 8), 
        axis.title = element_text(size = 8),
        axis.title.x = element_text(size = 9),  # Set the x-axis label size
        axis.title.y = element_text(size = 9),
        plot.title = element_text(size = 9)) + # Set the y-axis label size
  theme(legend.position = 'none') +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + #Remove gridlines
  scale_x_continuous(expand = c(0, 0), limits = c(60, 120)) +
  scale_y_continuous(expand = c(0, 0), limits = c(40,100))


ArmBefore #plot the plot


#dev.off() # turns off graphics device and exports the plot

```




All treatments: Righting Time v Mass (Baseline)
```{r}
RightBefore = ggplot(DATABaseline, aes(x=BodyMass_g, y=RightingTime, color = factor(Treatment)))+ 
  ylab("Righting Time (min)") + 
  xlab("Body Mass (g)") +
  ggtitle("Pre-experiment baseline")+
  geom_point(size=1) +  # Increase the size of the points 
  labs(color ="Treatment", labels = c("KA, 30 ppb",
                                      "KA, 3 ppb",
                                      "PBS")) +
  scale_color_manual(values=c("firebrick",
                              "darkorange",
                              "deepskyblue"),
                     labels = c(expression(paste("30 ", mu, "g KA ", g^-1, " bm")),
                                expression(paste("3 ", mu, "g KA ", g^-1, " bm")),
                                "PBS")) +
  geom_smooth(method="lm", se=FALSE, size = 0.5) +  # Add predictor lines using linear regression
  theme_bw() + 
  theme(panel.border = element_rect(fill = NA)) +
  theme(axis.text = element_text(size = 8), 
        axis.title = element_text(size = 84),
        axis.title.x = element_text(size = 9),  # Set the x-axis label size
        axis.title.y = element_text(size = 9),
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 8),
        plot.title = element_text(size = 9)) + # Set the y-axis label size
  theme(legend.position = c(0.77,0.76),
        legend.key.size = unit(0.3, "lines")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + #Remove gridlines
  scale_x_continuous(expand = c(0, 0), limits = c(60, 120)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0,35)) +
  geom_hline(yintercept = 30, linetype='dotted', col = 'red')+
  annotate("text", x = 68, y = 31, label = "Cut-off Time", vjust = -0.5, color='red', size = 2.5)


RightBefore #plot the plot


#dev.off() # turns off graphics device and exports the plot
```




All treatments: Righting Time v Mass (After Injection)
```{r}
RightAfter = ggplot(DATAResponse, aes(x=BodyMass_g, y=RightingTime,color = factor(Treatment)))+ 
  ylab("Righting Time (min)") + 
  xlab("Body Mass (g)") + 
  ggtitle("Post-injection (Day 0)")+
  geom_point(size = 1) +  # Increase the size of the points 
  labs(color ="Treatment", labels = c("KA, 30 ppb",
                                      "KA, 3 ppb",
                                      "PBS")) +
  scale_color_manual(values=c("firebrick",
                              "darkorange",
                              "deepskyblue")) +
  geom_smooth(method="lm", se=FALSE, size = 0.5) +  # Add predictor lines using linear regression
  theme_bw() +
  theme(panel.border = element_rect(fill = NA)) +
  theme(axis.text = element_text(size = 8), 
        axis.title = element_text(size = 8),
        axis.title.x = element_text(size = 9),  # Set the x-axis label size
        axis.title.y = element_text(size = 9),
        plot.title = element_text(size = 9)) + # Set the y-axis label size
  theme(legend.position = 'none') +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + #Remove gridlines
  scale_x_continuous(expand = c(0, 0), limits = c(60, 120)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0,35))+
  geom_hline(yintercept=30, linetype='dotted', col = 'red')+
  annotate("text", x = 68, y = 31, label = "Cut-off Time", vjust = -0.5, color='red', size = 2.5)


RightAfter #plot the plot


#dev.off() # turns off graphics device and exports the plot
```



All treatments: Arm circumference v Mass (After Injection)
```{r}
ArmAfter = ggplot(DATAResponse, aes(x=BodyMass_g, y=ArmCircumference,color = factor(Treatment)))+ 
  ylab("Arm Circumference (cm)") + 
  xlab("Body Mass (g)") +
  ggtitle("Post-injection (Day 0)")+
  geom_point(size = 1) +  # Increase the size of the points 
  labs(color ="Treatment", labels = c("KA, 30 ppb",
                                      "KA, 3 ppb",
                                      "PBS")) +
  scale_color_manual(values=c("firebrick",
                              "darkorange",
                              "deepskyblue")) +
  geom_smooth(method="lm", se=FALSE, size = 0.5) +  # Add predictor lines using linear regression
  theme_bw() +
  theme(panel.border = element_rect(fill = NA)) +
  theme(axis.text = element_text(size = 8), 
        axis.title = element_text(size = 8),
        axis.title.x = element_text(size = 9),  # Set the x-axis label size
        axis.title.y = element_text(size = 9),
        plot.title = element_text(size = 9)) + # Set the y-axis label size
  theme(legend.position = 'none') +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + #Remove gridlines
  scale_x_continuous(expand = c(0, 0), limits = c(60, 120)) +
  scale_y_continuous(expand = c(0, 0), limits = c(40,100))


ArmAfter #plot the plot


#dev.off() # turns off graphics device and exports the plot
```



Create stack plots of Righting Time and Arm Circumference
```{r}
library(cowplot)


StackPlots <- plot_grid(RightBefore, RightAfter, ArmBefore, ArmAfter, labels = "AUTO", label_size = 11, align = "v", hjust= -0.3, vjust = 2, scale = 0.94)

#Paper
png(filename = 'Figure3.png', height = 125, width = 169, units = "mm", res = 400)
StackPlots #plot the plot

pdf('Figure3.pdf', height = 125/25.4, width = 169/25.4)  # Convert mm to inches
StackPlots #plot the plot


dev.off() # turns off graphics device and exports the plot
```







Get mean and SD for body mass of sea stars
```{r}
#Pisaster ochraceus analyzed for PC (n = 28)
PisasterStat1 <- data.frame(
                mean = mean(PisasterPC$BodyMass_g, na.rm = TRUE),
                sd   = sd(PisasterPC$BodyMass_g, na.rm = TRUE)
)

PisasterStat1

#Pisaster ochraceus analyzed for all tissues (n = 6)
PisasterStat2 <- data.frame(
                mean = mean(Pisaster2$BodyMass_g, na.rm = TRUE),
                sd   = sd(Pisaster2$BodyMass_g, na.rm = TRUE)
)

PisasterStat2








#Asterias spp. from Experiment (n = 36)
#Data came from DATABaseline dataframe
AsteriasStat1<- data.frame(
                mean = mean(DATABaseline$BodyMass_g, na.rm = TRUE),
                sd   = sd(DATABaseline$BodyMass_g, na.rm = TRUE)
)

AsteriasStat1




#Filter out Asterias spp.
SeaStarsFilter <- filter(SeaStars, Species == "Asterias spp.")
#Asterias spp. baseline DA (n = 5)
AsteriasStat2<- data.frame(
                mean = mean(SeaStarsFilter$BodyMass_g, na.rm = TRUE),
                sd   = sd(SeaStarsFilter$BodyMass_g, na.rm = TRUE)
)

AsteriasStat2
```


















```{r}
library(emmeans)
library(lme4)
```

How long did it take PBS stars on average to right after injection?
```{r}
PBSstars <- DATAResponse %>%  
            filter(Date2 == "2023-04-06") %>% 
            filter(Treatment == "PBS")


PBSmean <- mean(PBSstars$RightingTime)
PBSsd <- sd(PBSstars$RightingTime)
PBSse <- sd(PBSstars$RightingTime)/sqrt(length(PBSstars$RightingTime))

```





